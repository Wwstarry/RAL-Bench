<contract>
1) Repository layout (packages/modules/files that must exist)
- Top-level package:
  - stegano/__init__.py
- LSB backend:
  - stegano/lsb/__init__.py
  - stegano/lsb/lsb.py
  - stegano/lsb/generators.py
- Red-channel backend:
  - stegano/red/__init__.py
  - stegano/red/red.py
- EXIF-header backend:
  - stegano/exifHeader/__init__.py
  - stegano/exifHeader/exifHeader.py
- WAV backend:
  - stegano/wav/__init__.py
  - stegano/wav/wav.py
- Shared tools:
  - stegano/tools/__init__.py
  - stegano/tools/bititerator.py
  - stegano/tools/utils.py
- Console namespace (must import without error; minimal implementation OK):
  - stegano/console/__init__.py
  - stegano/console/main.py
- Steganalysis namespace (must import without error; minimal implementation OK):
  - stegano/steganalysis/__init__.py

2) Public API surface (exports, modules, functions, signatures)
2.1 Package exports (must work)
- from stegano import lsb, red, exifHeader, wav
  - implies stegano/__init__.py must import/alias these subpackages.

2.2 stegano.lsb (must expose)
- stegano.lsb.hide(image, message, generator=None, shift=0, encoding="UTF-8", auto_convert_rgb=False) -> PIL.Image.Image
- stegano.lsb.reveal(image, generator=None, shift=0, encoding="UTF-8") -> str

2.3 stegano.lsb.generators (must expose)
- stegano.lsb.generators.eratosthenes() -> Iterator[int]

2.4 stegano.red (must expose)
- stegano.red.hide(image, message) -> PIL.Image.Image
- stegano.red.reveal(image) -> str

2.5 stegano.exifHeader (must expose)
- stegano.exifHeader.hide(input_image_file, output_path, secret_message=bytes, ...) -> None (must write output_path)
- stegano.exifHeader.reveal(image) -> bytes

2.6 stegano.wav (must expose)
- stegano.wav.hide(input_file, message, output_file, ...) -> None (must write output_file)
- stegano.wav.reveal(input_file, ...) -> str

2.7 Tools (internal but required by backends; must exist and import)
- stegano.tools.bititerator:
  - bit-level iterators/helpers used by image/audio backends.
- stegano.tools.utils:
  - utility functions for encoding/decoding, terminator handling, capacity checks, and PIL/wav helpers.

2.8 Console entry points (importable)
- stegano.console.main must exist; may provide a minimal CLI dispatcher or placeholder main().
- No strict CLI behavior required unless tests import modules.

3) Behavioral contract (I/O, invariants, edge cases, error handling)
3.1 Common conventions
- Encoding:
  - Text messages are encoded/decoded with the provided encoding parameter (default "UTF-8") where applicable.
- Terminator / end-of-message:
  - Image/audio text backends must embed a reliable end marker so reveal() can stop without external length.
  - Contract requirement: use a byte terminator sequence that is extremely unlikely in real text and consistent across hide/reveal for that backend.
  - Recommended: a fixed multi-byte sentinel (e.g., b"\x00\xff\x00\xff\x00\xff\x00\xff") appended to payload bytes for text backends.
- Capacity:
  - If the cover medium cannot hold the entire payload + terminator, raise ValueError (or a clear Exception subtype) rather than silently truncating.
- Determinism:
  - For a fixed image/audio input, message, generator, and shift, hide() must be deterministic and reveal() must return the same message.
- Cover size:
  - Image-based outputs must preserve width/height and mode semantics consistent with reference: do not resize or crop; only alter pixel channel LSBs as needed.
- Input flexibility:
  - Image arguments may be a PIL.Image.Image object or a path-like string; implementation may support both, but tests likely pass PIL images. If only one is supported, document and raise TypeError for unsupported types.

3.2 LSB backend (stegano.lsb)
3.2.1 hide(image, message, generator=None, shift=0, encoding="UTF-8", auto_convert_rgb=False) -> PIL.Image.Image
- Input:
  - image: PIL Image instance (primary). If a path is provided, open it with PIL.
  - message: str (primary); may also accept bytes (optional) but must at least handle str.
  - generator: None or an iterator of ints indicating pixel positions; if None, use sequential positions.
  - shift: int offset applied to generator-produced indices (position = index + shift).
  - auto_convert_rgb:
    - If True and image mode is not "RGB" or "RGBA", convert to "RGB" before embedding.
    - If False and image mode is unsupported for LSB operations, raise ValueError.
- Embedding model:
  - Hide bits in the least significant bit of image channels.
  - Supported modes:
    - "RGB": use 3 channels per pixel
    - "RGBA": use only RGB channels (or RGB+Alpha if chosen, but must be consistent between hide/reveal); recommended: only RGB to preserve alpha.
    - "L": use 1 channel per pixel (grayscale)
  - Order of channel writes: left-to-right, top-to-bottom pixels; within pixel, channel order R,G,B,(A if used).
  - If generator is provided:
    - generator yields a sequence of integer pixel indices (0..num_pixels-1) indicating which pixel to use next.
    - shift is applied after generation.
    - For each selected pixel index, embed into its channels in fixed order until bits consumed; if generator yields duplicates, later writes overwrite earlier bits (allowed).
  - Must append terminator to payload bytes before embedding.
- Output:
  - Return a new PIL.Image.Image instance (do not mutate input object in-place unless tests accept; safest: copy()).
  - Output size equals input size; mode equals input mode unless auto_convert_rgb triggers conversion to "RGB".
- Errors:
  - Raise ValueError for insufficient capacity.
  - Raise ValueError for unsupported image modes when auto_convert_rgb=False.

3.2.2 reveal(image, generator=None, shift=0, encoding="UTF-8") -> str
- Input:
  - image: PIL image or path.
  - generator/shift interpreted exactly as in hide().
- Extraction model:
  - Read LSBs in the same traversal and channel order used by hide().
  - Reconstruct bytes from bits (MSB-first per byte).
  - Stop at terminator; return decoded text prior to terminator.
- Output:
  - Return str decoded with encoding.
- Errors / edge cases:
  - If terminator not found, may return best-effort decoded text of all bytes read OR raise ValueError. Prefer raising ValueError for "no hidden message found" to align with typical stegano behavior, but ensure tests expectations: if uncertain, implement a conservative approach:
    - If no terminator found, return decoded bytes with errors="ignore" OR raise ValueError with clear message. (Implementation should choose one; recommended: raise ValueError.)

3.2.3 Generator support (stegano.lsb.generators.eratosthenes)
- Must return an infinite iterator of prime numbers in ascending order (2,3,5,7,11,...).
- Used as a pixel-position generator in hide/reveal when passed by caller.
- Must be pure Python, no external deps.

3.3 Red-channel backend (stegano.red)
3.3.1 hide(image, message) -> PIL.Image.Image
- Purpose:
  - Embed text into the red channel only, LSB-based.
- Input:
  - image: PIL Image or path.
  - message: str.
- Mode handling:
  - Ensure image is RGB (convert if necessary); output must be RGB.
- Embedding:
  - Only modify red channel LSB of each pixel (1 bit per pixel capacity).
  - Append a terminator to payload.
  - Walk pixels in raster order.
- Capacity check:
  - total bits required = (len(payload_bytes)+len(terminator)) * 8
  - capacity bits = width*height
  - Raise ValueError if insufficient.
- Output:
  - New PIL image same size.

3.3.2 reveal(image) -> str
- Extraction:
  - Read red channel LSBs across pixels; rebuild bytes; stop at terminator.
- Output:
  - Decode as UTF-8 (or default encoding consistent with hide; signature has no encoding arg, so fixed to UTF-8).
- Errors:
  - If terminator not found: raise ValueError or return "" (recommended: raise ValueError).

3.4 EXIF-header backend (stegano.exifHeader)
3.4.1 hide(input_image_file, output_path, secret_message=bytes, ...) MUST write output_path
- Primary goal:
  - Embed arbitrary bytes in JPEG/TIFF metadata (EXIF) without changing image dimensions/visual pixels.
- Signature flexibility:
  - hide(input_image_file, output_path, secret_message=bytes, ...) must accept at least:
    - input_image_file: path-like to input image
    - output_path: path-like to output image
    - secret_message: bytes (default param name must exist)
  - Additional parameters may be accepted via *args/**kwargs to satisfy tests that pass extra options; they must not break.
- Behavior:
  - Open image with PIL.
  - Write output image to output_path with secret bytes stored in EXIF tag(s).
  - Preferred storage:
    - Use EXIF UserComment tag (37510) or ImageDescription (270) if easier, base64-encode bytes into ASCII for robust storage.
    - Ensure reveal() can invert encoding and return original bytes.
  - Must preserve original image data as much as possible; do not resize/crop.
- Output:
  - Must create output_path file.
  - Return None (or output_path optionally; but tests require file written; safest: return output_path or None but ensure no mismatch if tests check None—prefer None).

3.4.2 reveal(image) -> bytes
- Input:
  - image: path-like or PIL image.
- Behavior:
  - Extract the stored secret bytes from the EXIF tag(s) used by hide().
  - Decode base64 if used.
- Output:
  - Return bytes exactly as embedded.
- Errors:
  - If no embedded message found, raise ValueError.

3.5 WAV backend (stegano.wav)
3.5.1 hide(input_file, message, output_file, ...) MUST write output_file
- Input:
  - input_file: path-like to WAV file (PCM).
  - message: str (primary).
  - output_file: path-like to output WAV file.
  - Accept optional kwargs (e.g., encoding, num_lsb) for forward compatibility; must not break.
- WAV constraints:
  - Support uncompressed PCM WAV (8/16/24/32-bit integer). At minimum, 8-bit unsigned and 16-bit signed should work.
  - Preserve original parameters: nchannels, sampwidth, framerate, nframes, comptype, compname.
- Embedding:
  - Embed message bytes + terminator in LSB of audio samples.
  - For multi-channel audio, treat samples interleaved; embed sequentially across frames/channels.
  - Capacity bits = total_samples * 1 (if 1 LSB used).
  - If insufficient capacity, raise ValueError.
- Output:
  - Write modified WAV to output_file.
  - Return None.

3.5.2 reveal(input_file, ...) -> str
- Input:
  - input_file path-like.
  - Accept optional kwargs (encoding default UTF-8).
- Behavior:
  - Read LSBs from samples in same order; reconstruct bytes; stop at terminator; decode to str.
- Errors:
  - If terminator not found, raise ValueError.

3.6 Tools behavior (stegano.tools)
- Must provide bit/byte conversion utilities used consistently by backends:
  - Convert bytes -> iterable of bits (0/1) MSB-first.
  - Convert bits -> bytes.
  - Sentinel handling: append/find terminator in byte stream.
- Must provide capacity helper(s) and image mode/channel helpers to avoid duplicated logic.

3.7 Console and steganalysis namespaces
- Must exist and be importable.
- No functional CLI/steganalysis required beyond not crashing on import.
- If console/main.py defines a main(argv=None) it must not require external dependencies.

4) Acceptance checklist (verifiable, mapped to test intent)
- Imports:
  - Importing stegano succeeds.
  - from stegano import lsb, red, exifHeader, wav succeeds.
  - from stegano.lsb.generators import eratosthenes succeeds.
  - Importing stegano.console and stegano.steganalysis succeeds.
- LSB:
  - stegano.lsb.hide returns a PIL.Image.Image.
  - stegano.lsb.reveal returns the original message for:
    - default sequential embedding (generator=None)
    - generator-based embedding using stegano.lsb.generators.eratosthenes()
    - non-zero shift values
  - Output image has same dimensions as input; no resize/crop.
  - Raises ValueError when message does not fit.
- Red:
  - stegano.red.hide returns a PIL.Image.Image with same dimensions.
  - stegano.red.reveal returns the original UTF-8 message.
  - Only red channel LSB modifications are used (visual integrity not strictly asserted, but should be consistent).
  - Raises ValueError on insufficient capacity.
- EXIF header:
  - stegano.exifHeader.hide writes output_path file.
  - stegano.exifHeader.reveal reads and returns the exact embedded bytes.
  - No pixel-size changes.
  - Raises ValueError if no embedded metadata message found.
- WAV:
  - stegano.wav.hide writes output_file WAV readable by Python wave module.
  - stegano.wav.reveal returns the original message.
  - Preserves WAV parameters (channels/sample width/framerate/frame count) aside from sample LSB changes.
  - Raises ValueError on insufficient capacity or missing terminator.
- No dependency on the external “stegano” reference project; implementation is standalone pure Python.

5) Non-goals / constraints
- Do not call external services or require network access.
- Do not require non-standard system binaries.
- Avoid heavy optional dependencies; only rely on Python stdlib plus Pillow (PIL) for image I/O if available in test environment.
- Do not implement full CLI parity; only ensure console namespace imports.
- Do not implement advanced steganalysis algorithms; only provide placeholder module(s) if needed.
- Do not change cover media dimensions or formats beyond what is required to write the output (EXIF/WAV) and minimal safe conversions (RGB conversion when explicitly requested/required).
</contract>